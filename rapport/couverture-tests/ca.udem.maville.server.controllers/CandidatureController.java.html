<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CandidatureController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">maVille</a> &gt; <a href="index.source.html" class="el_package">ca.udem.maville.server.controllers</a> &gt; <span class="el_source">CandidatureController.java</span></div><h1>CandidatureController.java</h1><pre class="source lang-java linenums">package ca.udem.maville.server.controllers;

import ca.udem.maville.hooks.UseRequest;
import ca.udem.maville.server.dao.files.CandidatureDAO;
import ca.udem.maville.server.models.Candidature;
import ca.udem.maville.utils.RequestType;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.javalin.http.Context;

import io.javalin.json.JavalinJackson;
import org.bson.types.ObjectId;
import org.slf4j.Logger;

import java.util.List;


/**
 * La controller qui gère les différentes interactions du client avec le serveur
 * en tout ce qui concerne les candidatures.
 */
public class CandidatureController {
    public String urlHead;
    public Logger logger;

<span class="fc" id="L26">    public CandidatureController( String urlHead, Logger logger) {</span>
<span class="fc" id="L27">        this.urlHead = urlHead;</span>
<span class="fc" id="L28">        this.logger = logger;</span>
<span class="fc" id="L29">    }</span>

    /**
     * Cette route permet de récupérer toutes les candidatures non traitées présentes
     * dans la base de données.
     * @param ctx qui représente le contexte de la requête.
     */
    public void getAll(Context ctx) {
        try {
<span class="nc" id="L38">            List&lt;Candidature&gt; candidatures = CandidatureDAO.findAll();</span>

<span class="nc" id="L40">            ctx.status(200).json(candidatures).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L41">        } catch (Exception e) {</span>
<span class="nc" id="L42">            e.printStackTrace();</span>
<span class="nc" id="L43">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L44">        }</span>
<span class="nc" id="L45">    }</span>

    /**
     * Cette route permet de récupérer toutes les candidatures d'un prestaire.
     * Le paramètre de path user représente l'id du prestataire.
     * @param ctx qui représente le contexte de la requête
     */
    public void getByPrestataire(Context ctx) {
        try {
<span class="nc" id="L54">            String idUser = ctx.pathParam(&quot;user&quot;);</span>

<span class="nc" id="L56">            List&lt;Candidature&gt; candidatures = CandidatureDAO.findPrestataireCandidatures(new ObjectId(idUser));</span>

            // Renvoyer les candidatures trouvées dans un tableau
<span class="nc" id="L59">            ctx.status(200).json(candidatures).contentType(&quot;application/json&quot;);</span>

<span class="nc" id="L61">        } catch (Exception e) {</span>
<span class="nc" id="L62">            e.printStackTrace();</span>
<span class="nc" id="L63">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L64">        }</span>
<span class="nc" id="L65">    }</span>


    /**
     * Cette route permet de créer une nouvelle candidature pour un prestataire.
     * Le body doit contenir toutes informations nécessaires notamment :
     * - prestataire: qui est l'id du prestataire qui dépose la candidature. Très important.
     * - nomPrestataire: qui représente le nom de l'entreprise
     * - ficheProbleme: qui est l'id de la fiche problème concernée
     * - numeroEntreprise: qui représente le numéro d'entreprise du prestataire
     * - titreProjet: qui est le titre du projet proposé
     * - description: La description du projet proposé
     * - typeTravaux: qui représente le type travail à réaliser sous forme Label
     * - coutEstime: Le cout proposé pour le projet
     * - dateDebut: qui doit être sous format ISO
     * - dateFin: qui doit être sous format ISO
     * - ruesAffectees: Les rues affectées par les travaux sous forme de String
     * Elle s'occupe automatiquement d'assigner les champs id et statut.
     * Elle inclut aussi un envoi de notification au STPM.
     * @param ctx représente le contexte de la requête
     */
    public void create(Context ctx) {
        try {
            // Récupérer les informations sur la nouvelle candidature
<span class="fc" id="L89">            Candidature newCandidature = ctx.bodyAsClass(Candidature.class);</span>

            // S'assurer que le statut est le bon avant de sauvegarder
<span class="fc" id="L92">            newCandidature.setStatut(&quot;en attente&quot;);</span>
<span class="fc" id="L93">            CandidatureDAO.save(newCandidature);</span>

            // Envoyer une notification au STPM.
<span class="fc" id="L96">            String body = &quot;{&quot; +</span>
                    &quot;\&quot;message\&quot;: \&quot;Une nouvelle candidature a été déposée par un prestataire.\&quot;,&quot; +
                    &quot;\&quot;user\&quot;: \&quot;507f1f77bcf86cd799439011\&quot;,&quot; +
<span class="fc" id="L99">                    &quot;\&quot;url\&quot;: \&quot;/stpm/candidature/&quot; + newCandidature.getId() + &quot;\&quot;&quot; +</span>
                    &quot;}&quot;;
<span class="fc" id="L101">            String response = UseRequest.sendRequest(urlHead + &quot;/notification&quot;, RequestType.POST, body);</span>

<span class="fc" id="L103">            ObjectMapper mapper = JavalinJackson.defaultMapper();</span>
<span class="fc" id="L104">            JsonNode json = mapper.readTree(response);</span>

<span class="nc bnc" id="L106" title="All 2 branches missed.">            if(json.get(&quot;status&quot;).asInt() != 201) {</span>
<span class="nc" id="L107">                JsonNode data = json.get(&quot;data&quot;);</span>
<span class="nc" id="L108">                throw new Exception(data.get(&quot;message&quot;).asText());</span>
            }

            // Renvoyer la candidature avec un message de succès
<span class="nc" id="L112">            ctx.status(201).json(newCandidature).contentType(&quot;application/json&quot;);</span>
<span class="fc" id="L113">        } catch (Exception e) {</span>
<span class="fc" id="L114">            e.printStackTrace();</span>
<span class="fc" id="L115">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L116">        }</span>
<span class="fc" id="L117">    }</span>


    /**
     * Cette route permet de récupérer une candidature en particulier à
     * partir de son id. Elle marque automatiquement la candidature comme vue.
     * Elle nécessite un query parameter stpm qui est un booléen qui précise si c'est le STPM
     * qui a vu le signalement.
     * @param ctx représente le contexte de la requête.
     */
    public void getById(Context ctx) {
        try {
<span class="fc" id="L129">            String id = ctx.pathParam(&quot;id&quot;);</span>
<span class="fc" id="L130">            boolean isStpm = Boolean.parseBoolean(ctx.queryParam(&quot;stpm&quot;));</span>

<span class="fc" id="L132">            Candidature candidature = CandidatureDAO.findById(new ObjectId(id));</span>

<span class="fc bfc" id="L134" title="All 2 branches covered.">            if (candidature == null) {</span>
<span class="fc" id="L135">                ctx.status(404).result(&quot;{\&quot;message\&quot;: \&quot;Aucune candidature avec un tel ID trouvée.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="fc" id="L136">                return;</span>
            }

<span class="pc bpc" id="L139" title="3 of 4 branches missed.">            if(isStpm &amp;&amp; candidature.getStatut().equals(&quot;en attente&quot;)) {</span>
<span class="nc" id="L140">                candidature.setStatut(&quot;vue&quot;);</span>
<span class="nc" id="L141">                CandidatureDAO.save(candidature);</span>
            }

            // Renvoyer la candidature
<span class="nc" id="L145">            ctx.status(200).json(candidature).contentType(&quot;application/json&quot;);</span>
<span class="fc" id="L146">        } catch (Exception e) {</span>
<span class="fc" id="L147">            e.printStackTrace();</span>
<span class="fc" id="L148">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L149">        }</span>
<span class="fc" id="L150">    }</span>


    /**
     * Cette route permet de modifier les informations d'une candidature, connaissant son id.
     * Le body doit contenir tout l'objet de candidature avec les champ modifiés.
     * Assurez vous que la nouvelle information a le bon type.
     * La modification n'est possible que si la candidature n'a pas encore été vue ou traitée.
     * NB: Elle remplace complètement les champs tableaux de la base de données par ceux envoyés.
     * @param ctx qui représente le contexte de la requête.
     */
    public void patch(Context ctx) {
        try {
<span class="nc" id="L163">            String id = ctx.pathParam(&quot;id&quot;);</span>

            // On réalise une vérification supplémentaire pour s'assurer que la candidature
            // n'est pas déjà traitée.
<span class="nc" id="L167">            Candidature candidature = CandidatureDAO.findById(new ObjectId(id));</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">            if(candidature == null) {</span>
<span class="nc" id="L170">                ctx.status(404).result(&quot;{\&quot;message\&quot;: \&quot;Aucune candidature avec un tel ID trouvée.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L171">                return;</span>
            }

<span class="nc bnc" id="L174" title="All 2 branches missed.">            if(!candidature.getStatut().equals(&quot;en attente&quot;)) {</span>
<span class="nc" id="L175">                ctx.status(403).result(&quot;{\&quot;message\&quot;: \&quot;Cette candidature a déjà été vue apr le STPM. Vous ne pouvez pas la modifier.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L176">                return;</span>
            }

<span class="nc" id="L179">            Candidature modifiedCandidature = ctx.bodyAsClass(Candidature.class);</span>

<span class="nc" id="L181">            CandidatureDAO.save(modifiedCandidature);</span>

<span class="nc" id="L183">            ctx.status(200).json(modifiedCandidature).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L184">        } catch (Exception e) {</span>
<span class="nc" id="L185">            e.printStackTrace();</span>
<span class="nc" id="L186">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L187">        }</span>
<span class="nc" id="L188">    }</span>

    /**
     * Cette route permet de supprimer une candidature à partir de son id
     * @param ctx qui représente le contexte de la requête.
     */
    public void delete(Context ctx) {
        try {
<span class="nc" id="L196">            String id = ctx.pathParam(&quot;id&quot;);</span>

<span class="nc" id="L198">            CandidatureDAO.delete(new ObjectId(id));</span>

            // Supprimer la notification
<span class="nc" id="L201">            String response = UseRequest.sendRequest(urlHead + &quot;/notification/deleteByUrl/&quot; + id + &quot;?signalement=false&quot;, RequestType.DELETE, null);</span>

<span class="nc" id="L203">            JsonNode json = JavalinJackson.defaultMapper().readTree(response);</span>

<span class="nc bnc" id="L205" title="All 2 branches missed.">            if(json.get(&quot;status&quot;).asInt() != 200) {</span>
<span class="nc" id="L206">                JsonNode data = json.get(&quot;data&quot;);</span>
<span class="nc" id="L207">                throw new Exception(data.get(&quot;message&quot;).asText());</span>
            }

            // Renvoyer la réponse de succès
<span class="nc" id="L211">            ctx.status(200).result(&quot;{\&quot;message\&quot;: \&quot;Suppression réalisée avec succès.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L212">        } catch (Exception e) {</span>
<span class="nc" id="L213">            e.printStackTrace();</span>
<span class="nc" id="L214">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L215">        }</span>
<span class="nc" id="L216">    }</span>

    /**
     * Marque une candidature comme acceptée. Elle inclut l'envoi de la notification au prestataire.
     * @param ctx qui représente le contexte de la requête.
     */
    public void markAsAccepted(Context ctx) {
        try {
<span class="nc" id="L224">            String id = ctx.pathParam(&quot;id&quot;);</span>

<span class="nc" id="L226">            Candidature candidature = CandidatureDAO.findById(new ObjectId(id));</span>

<span class="nc bnc" id="L228" title="All 2 branches missed.">            if(candidature == null) {</span>
<span class="nc" id="L229">                ctx.status(404).result(&quot;{\&quot;message\&quot;: \&quot;Aucune candidature avec un tel ID trouvée.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L230">                return;</span>
            }

<span class="nc" id="L233">            candidature.setStatut(&quot;acceptée&quot;);</span>
<span class="nc" id="L234">            CandidatureDAO.save(candidature);</span>

            // Envoyer une notification au prestataire.
<span class="nc" id="L237">            String body = &quot;{&quot; +</span>
<span class="nc" id="L238">                    &quot;\&quot;message\&quot;: \&quot;Votre candidature au projet &quot; + candidature.getTitreProjet() + &quot; a été acceptée. Veuillez consulter vos projets récents pour visualiser le projet créé.\&quot;,&quot; +</span>
<span class="nc" id="L239">                    &quot;\&quot;user\&quot;: \&quot;&quot; + candidature.getPrestataire() + &quot;\&quot;&quot; +</span>
                    &quot;}&quot;;
<span class="nc" id="L241">            String response = UseRequest.sendRequest(urlHead + &quot;/notification&quot;, RequestType.POST, body);</span>

<span class="nc" id="L243">            ObjectMapper mapper = JavalinJackson.defaultMapper();</span>
<span class="nc" id="L244">            JsonNode json = mapper.readTree(response);</span>

<span class="nc bnc" id="L246" title="All 2 branches missed.">            if(json.get(&quot;status&quot;).asInt() != 201) {</span>
<span class="nc" id="L247">                JsonNode data = json.get(&quot;data&quot;);</span>
<span class="nc" id="L248">                throw new Exception(data.get(&quot;message&quot;).asText());</span>
            }

            // Renvoyer la réponse de succès
<span class="nc" id="L252">            ctx.status(200).json(candidature).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L253">        } catch (Exception e) {</span>
<span class="nc" id="L254">            e.printStackTrace();</span>
<span class="nc" id="L255">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L256">        }</span>
<span class="nc" id="L257">    }</span>

    /**
     * Marque une candidature comme rejetée. Elle inclut l'envoi de la notification au prestataire.
     * Le body doit contenir un champ raison qui donne la raison du rejet.
     * @param ctx qui représente le contexte de la requête.
     */
    public void markAsRejected(Context ctx) {
        try {
<span class="nc" id="L266">            String id = ctx.pathParam(&quot;id&quot;);</span>

<span class="nc" id="L268">            Candidature candidature = CandidatureDAO.findById(new ObjectId(id));</span>

<span class="nc bnc" id="L270" title="All 2 branches missed.">            if(candidature == null) {</span>
<span class="nc" id="L271">                ctx.status(404).result(&quot;{\&quot;message\&quot;: \&quot;Aucune candidature avec un tel ID trouvée.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L272">                return;</span>
            }

<span class="nc" id="L275">            candidature.setStatut(&quot;refusée&quot;);</span>
<span class="nc" id="L276">            CandidatureDAO.save(candidature);</span>

            // Prendre la raison du rejet dans le body et envoyer la notification
<span class="nc" id="L279">            ObjectMapper mapper = JavalinJackson.defaultMapper();</span>
<span class="nc" id="L280">            JsonNode json = mapper.readTree(ctx.body());</span>

<span class="nc bnc" id="L282" title="All 2 branches missed.">            if(!json.has(&quot;raison&quot;)) {</span>
<span class="nc" id="L283">                ctx.status(400).result(&quot;{\&quot;message\&quot;: \&quot;Une raison est nécessaire lors du rejet d'une candidature.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L284">                return;</span>
            }

<span class="nc" id="L287">            String body = &quot;{&quot; +</span>
                    &quot;\&quot;message\&quot;: \&quot;Merci pour votre intérêt pour les problèmes de la ville de Montréal. Nous avons le regret de vous annoncer &quot; +
<span class="nc bnc" id="L289" title="All 2 branches missed.">                    &quot;que votre candidature au projet &quot; + candidature.getTitreProjet() + &quot; a été réjetée. La raison est la suivante : &quot; + json.get(&quot;raison&quot;).asText() + (json.get(&quot;raison&quot;).asText().endsWith(&quot;.&quot;) ? &quot;&quot; : &quot;.&quot;) + &quot;\&quot;,&quot; +</span>
<span class="nc" id="L290">                    &quot;\&quot;user\&quot;: \&quot;&quot; + candidature.getPrestataire() + &quot;\&quot;&quot; +</span>
                    &quot;}&quot;;
<span class="nc" id="L292">            String response = UseRequest.sendRequest(urlHead + &quot;/notification&quot;, RequestType.POST, body);</span>

<span class="nc" id="L294">            JsonNode json1 = mapper.readTree(response);</span>

<span class="nc bnc" id="L296" title="All 2 branches missed.">            if(json1.get(&quot;status&quot;).asInt() != 201) {</span>
<span class="nc" id="L297">                JsonNode data = json1.get(&quot;data&quot;);</span>
<span class="nc" id="L298">                throw new Exception(data.get(&quot;message&quot;).asText());</span>
            }

            // Renvoyer la réponse de succès
<span class="nc" id="L302">            ctx.status(200).json(candidature).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L303">        } catch (Exception e) {</span>
<span class="nc" id="L304">            e.printStackTrace();</span>
<span class="nc" id="L305">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L306">        }</span>
<span class="nc" id="L307">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>