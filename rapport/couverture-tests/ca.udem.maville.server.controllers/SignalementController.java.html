<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SignalementController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">maVille</a> &gt; <a href="index.source.html" class="el_package">ca.udem.maville.server.controllers</a> &gt; <span class="el_source">SignalementController.java</span></div><h1>SignalementController.java</h1><pre class="source lang-java linenums">package ca.udem.maville.server.controllers;

import ca.udem.maville.hooks.UseRequest;
import ca.udem.maville.server.dao.files.SignalementDAO;
import ca.udem.maville.server.models.Signalement;
import ca.udem.maville.utils.RequestType;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.javalin.http.Context;
import io.javalin.json.JavalinJackson;
import org.bson.types.ObjectId;
import org.slf4j.Logger;

import java.util.List;


/**
 * La controller qui gère les différentes interactions du client avec le serveur
 * en tout ce qui concerne les signalements.
 */
public class SignalementController {

    public String urlHead;
    public Logger logger;


<span class="fc" id="L27">    public SignalementController(String urlHead, Logger logger) {</span>
<span class="fc" id="L28">        this.urlHead = urlHead;</span>
<span class="fc" id="L29">        this.logger = logger;</span>
<span class="fc" id="L30">    }</span>

    /**
     * Cette route permet de récupérer tous les signalements non traités présents dans la base
     * de données.
     * @param ctx qui représente le contexte de la requête
     */
    public void getAll(Context ctx) {
        try {
<span class="fc" id="L39">            List&lt;Signalement&gt; signalements = SignalementDAO.findAll();</span>

            // Renvoyer les signalements trouvés.
<span class="nc" id="L42">            ctx.status(200).json(signalements).contentType(&quot;application/json&quot;);</span>
<span class="fc" id="L43">        } catch (Exception e) {</span>
<span class="fc" id="L44">            e.printStackTrace();</span>
<span class="fc" id="L45">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L46">        }</span>
<span class="fc" id="L47">    }</span>

    /**
     * Cette route permet de créer un nouveau signalement pour un résident.
     * Le body doit contenir toutes informations nécessaires notamment :
     * - typeProbleme: qui représente le type travail requis.
     * - quartier: qui représente le quartier affecté.
     * - localisation: ici on s'intéressera principalement à la rue ou à l'adresse du résident
     * - description: la description du problème rencontré
     * - resident: l'id du résident faisant le signalement. Très important
     * Elle s'occupe automatiquement d'assigner les champs id et statut.
     * Elle implémente aussi un envoi de notification au STPM.
     * @param ctx représente le contexte de la requête
     */
    public void create(Context ctx) {
        try {
            // Récupérer les informations du nouveau signalement.
<span class="fc" id="L64">            Signalement newSignalement = ctx.bodyAsClass(Signalement.class);</span>

            // S'assurer que le statut est bon avant de le sauvegarder
<span class="fc" id="L67">            newSignalement.setStatut(&quot;en attente&quot;);</span>
<span class="fc" id="L68">            SignalementDAO.save(newSignalement);</span>

            // Envoyer une notification au STPM
<span class="fc" id="L71">            String body = &quot;{&quot; +</span>
                    &quot;\&quot;message\&quot;: \&quot;Un nouveau signalement a été créé par un résident.\&quot;,&quot; +
                    &quot;\&quot;user\&quot;: \&quot;507f1f77bcf86cd799439011\&quot;,&quot; +
<span class="fc" id="L74">                    &quot;\&quot;url\&quot;: \&quot;/stpm/signalement/&quot; + newSignalement.getId() + &quot;\&quot;&quot; +</span>
                    &quot;}&quot;;
<span class="fc" id="L76">            String response = UseRequest.sendRequest(urlHead + &quot;/notification&quot;, RequestType.POST, body);</span>

<span class="fc" id="L78">            ObjectMapper mapper = JavalinJackson.defaultMapper();</span>
<span class="fc" id="L79">            JsonNode json = mapper.readTree(response);</span>

<span class="nc bnc" id="L81" title="All 2 branches missed.">            if(json.get(&quot;status&quot;).asInt() != 201) {</span>
<span class="nc" id="L82">                JsonNode data = json.get(&quot;data&quot;);</span>
<span class="nc" id="L83">                throw new Exception(data.get(&quot;message&quot;).asText());</span>
            }

            // Renvoyer le signalement avec un message de succès
<span class="nc" id="L87">            ctx.status(201).json(newSignalement).contentType(&quot;application/json&quot;);</span>
<span class="fc" id="L88">        } catch (Exception e) {</span>
<span class="fc" id="L89">            e.printStackTrace();</span>
<span class="fc" id="L90">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L91">        }</span>
<span class="fc" id="L92">    }</span>

    /**
     * Cette route permet de récupérer un signalement en particulier à
     * partir de son id. Elle marque automatiquement le signalement comme vu.
     * Elle nécessite un query parameter stpm qui est un booléen qui précise si c'est le STPM
     * qui a vu le signalement.
     * @param ctx représente le contexte de la requête.
     */
    public void getById(Context ctx) {
        try {
<span class="fc" id="L103">            String id = ctx.pathParam(&quot;id&quot;);</span>
<span class="fc" id="L104">            boolean isStpm = Boolean.parseBoolean(ctx.queryParam(&quot;stpm&quot;));</span>

<span class="fc" id="L106">            Signalement signalement = SignalementDAO.findById(new ObjectId(id));</span>

<span class="pc bpc" id="L108" title="1 of 2 branches missed.">            if (signalement == null) {</span>
<span class="nc" id="L109">                ctx.status(404).result(&quot;{\&quot;message\&quot;: \&quot;Aucun signalement avec un tel ID trouvé.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L110">                return;</span>
            }

<span class="pc bpc" id="L113" title="3 of 4 branches missed.">            if(isStpm &amp;&amp; signalement.getStatut().equals(&quot;en attente&quot;)) {</span>
<span class="nc" id="L114">                signalement.setStatut(&quot;vu&quot;);</span>
<span class="nc" id="L115">                SignalementDAO.save(signalement);</span>
            }

            // Renvoyer le signalement trouvé
<span class="nc" id="L119">            ctx.status(200).json(signalement).contentType(&quot;application/json&quot;);</span>
<span class="fc" id="L120">        } catch (Exception e) {</span>
<span class="fc" id="L121">            e.printStackTrace();</span>
<span class="fc" id="L122">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L123">        }</span>
<span class="fc" id="L124">    }</span>

    /**
     * Cette route permet de récupérer tous les signalements d'un résident en particulier.
     * Le path parameter user contient l'id du résident.
     * @param ctx qui représente le contexte de la requête.
     */
    public void getByResident(Context ctx) {
        try {
<span class="nc" id="L133">            String userId = ctx.pathParam(&quot;user&quot;);</span>

<span class="nc" id="L135">            List&lt;Signalement&gt; signalements = SignalementDAO.findResidentSignalements(new ObjectId(userId));</span>

<span class="nc" id="L137">            ctx.status(200).json(signalements).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L138">        } catch (Exception e) {</span>
<span class="nc" id="L139">            e.printStackTrace();</span>
<span class="nc" id="L140">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L141">        }</span>
<span class="nc" id="L142">    }</span>

    /**
     * Cette route permet de modifier seulement partiellement les informations
     * d'un signalement, connaissant son id.
     * Le body doit contenir tout l'objet de signalement avec les champs à modifier.
     * Assurez vous que la nouvelle information a le bon type.
     * La modification n'est possible que si le signalement n'a pas encore été vu ou traité.
     * NB: Elle remplace complètement les champs tableaux de la base de données par ceux envoyés.
     * @param ctx qui représente le contexte de la requête.
     */
    public void patch(Context ctx) {
        try {
<span class="nc" id="L155">            String id = ctx.pathParam(&quot;id&quot;);</span>

            // La modification est possible seulement si pas encore traité ou vu
<span class="nc" id="L158">            Signalement signalement = SignalementDAO.findById(new ObjectId(id));</span>

<span class="nc bnc" id="L160" title="All 2 branches missed.">            if(signalement == null) {</span>
<span class="nc" id="L161">                ctx.status(404).result(&quot;{\&quot;message\&quot;: \&quot;Aucun signalement avec un tel ID trouvée.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L162">                return;</span>
            }

<span class="nc bnc" id="L165" title="All 2 branches missed.">            if(!signalement.getStatut().equals(&quot;en attente&quot;)) {</span>
<span class="nc" id="L166">                ctx.status(403).result(&quot;{\&quot;message\&quot;: \&quot;Ce signalement a déjà été vu par le STPM. Vous ne pouvez pas le modifier.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L167">                return;</span>
            }

<span class="nc" id="L170">            Signalement modifiedSignalement = ctx.bodyAsClass(Signalement.class);</span>

<span class="nc" id="L172">            SignalementDAO.save(modifiedSignalement);</span>

<span class="nc" id="L174">            ctx.status(200).json(modifiedSignalement).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L175">        } catch (Exception e) {</span>
<span class="nc" id="L176">            e.printStackTrace();</span>
<span class="nc" id="L177">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L178">        }</span>
<span class="nc" id="L179">    }</span>

    /**
     * Cette route permet de supprimer un signalement à partir de son id
     * @param ctx qui représente le contexte de la requête.
     */
    public void delete(Context ctx) {
        try {
<span class="nc" id="L187">            String id = ctx.pathParam(&quot;id&quot;);</span>

<span class="nc" id="L189">            SignalementDAO.delete(new ObjectId(id));</span>

            // Supprimer la notification
<span class="nc" id="L192">            String response = UseRequest.sendRequest(urlHead + &quot;/notification/deleteByUrl/&quot; + id + &quot;?signalement=true&quot;, RequestType.DELETE, null);</span>

<span class="nc" id="L194">            JsonNode json = JavalinJackson.defaultMapper().readTree(response);</span>

<span class="nc bnc" id="L196" title="All 2 branches missed.">            if(json.get(&quot;status&quot;).asInt() != 200) {</span>
<span class="nc" id="L197">                JsonNode data = json.get(&quot;data&quot;);</span>
<span class="nc" id="L198">                throw new Exception(data.get(&quot;message&quot;).asText());</span>
            }

            // Renvoyer la réponse de succès
<span class="nc" id="L202">            ctx.status(200).result(&quot;{\&quot;message\&quot;: \&quot;Suppression réalisée avec succès.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L203">        } catch (Exception e) {</span>
<span class="nc" id="L204">            e.printStackTrace();</span>
<span class="nc" id="L205">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L206">        }</span>
<span class="nc" id="L207">    }</span>

    /**
     * Cette route permet de marquer un signalement comme traité.
     * Elle requiert un query parameter treated qui est un booléen
     * informant si un projet existe déjà pour le signalement.
     * @param ctx qui représente le contexte de la requête.
     */
    public void markAsProcessed(Context ctx) {
        try {
<span class="nc" id="L217">            String id = ctx.pathParam(&quot;id&quot;);</span>
<span class="nc" id="L218">            boolean treated = Boolean.parseBoolean(ctx.queryParam(&quot;treated&quot;));</span>

<span class="nc" id="L220">            Signalement signalement = SignalementDAO.findById(new ObjectId(id));</span>

<span class="nc bnc" id="L222" title="All 2 branches missed.">            if(signalement == null) {</span>
<span class="nc" id="L223">                ctx.status(404).result(&quot;{\&quot;message\&quot;: \&quot;Aucun signalement avec un tel ID trouvée.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L224">                return;</span>
            }

<span class="nc" id="L227">            signalement.setStatut(&quot;traité&quot;);</span>
<span class="nc" id="L228">            SignalementDAO.save(signalement);</span>

            // Envoyer une notification au résident.
<span class="nc bnc" id="L231" title="All 2 branches missed.">            String message = (treated) ? &quot;Un projet existe déjà pour régler ce problème. Veuillez consulter la&quot; +</span>
<span class="nc" id="L232">                    &quot; liste des projets récents pour plus d'informations.&quot; : &quot;Vous serez notifié lorsqu'un projet pour le résoudre aura été créé.&quot;;</span>
<span class="nc" id="L233">            String body = &quot;{&quot; +</span>
                    &quot;\&quot;message\&quot;: \&quot;Votre signalement à été traité par le STPM. &quot; + message + &quot;\&quot;,&quot; +
<span class="nc" id="L235">                    &quot;\&quot;user\&quot;: \&quot;&quot; + signalement.getResident() + &quot;\&quot;,&quot; +</span>
<span class="nc" id="L236">                    &quot;\&quot;url\&quot;: \&quot;/resident/signalement/&quot; + signalement.getId() + &quot;\&quot;&quot; +</span>
                    &quot;}&quot;;
<span class="nc" id="L238">            String response = UseRequest.sendRequest(urlHead + &quot;/notification&quot;, RequestType.POST, body);</span>

<span class="nc" id="L240">            ObjectMapper mapper = JavalinJackson.defaultMapper();</span>
<span class="nc" id="L241">            JsonNode json = mapper.readTree(response);</span>

<span class="nc bnc" id="L243" title="All 2 branches missed.">            if(json.get(&quot;status&quot;).asInt() != 201) {</span>
<span class="nc" id="L244">                JsonNode data = json.get(&quot;data&quot;);</span>
<span class="nc" id="L245">                throw new Exception(data.get(&quot;message&quot;).asText());</span>
            }

            // Renvoyer la réponse de succès
<span class="nc" id="L249">            ctx.status(200).json(signalement).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L250">        } catch (Exception e) {</span>
<span class="nc" id="L251">            e.printStackTrace();</span>
<span class="nc" id="L252">            ctx.status(500).result(&quot;{\&quot;message\&quot;: \&quot;Une erreur est interne survenue! Veuillez réessayer plus tard.\&quot;}&quot;).contentType(&quot;application/json&quot;);</span>
<span class="nc" id="L253">        }</span>
<span class="nc" id="L254">    }</span>
}






</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>